name: Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Production Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd ${{ secrets.PRODUCTION_PATH }}
          
          # Pull latest changes from GitHub
          echo "ğŸ“¥ Pulling latest changes from master branch..."
          git fetch origin
          git reset --hard origin/master
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          yarn install
          
          # Build the application
          echo "ğŸ”¨ Building application..."
          yarn build
          
          # Check if PM2 is installed, if not install it
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ Installing PM2..."
            sudo npm install -g pm2 || echo "âš ï¸  PM2 installation failed, will use npx pm2"
          fi
          
          # Restart PM2 process
          echo "â™»ï¸  Restarting application..."
          
          # Use pm2 if available, otherwise use npx pm2
          PM2_CMD="pm2"
          if ! command -v pm2 &> /dev/null; then
            PM2_CMD="npx pm2"
          fi
          
          if $PM2_CMD list | grep -q "website"; then
            $PM2_CMD restart website
          else
            $PM2_CMD start yarn --name "website" -- start
          fi
          
          $PM2_CMD save
          
          echo "âœ… Deployment completed successfully!"
          $PM2_CMD list

    - name: Cleanup local artifacts
      if: always()
      run: |
        if [ -f deploy.tar.gz ]; then
          rm deploy.tar.gz
          echo "ğŸ§¹ Cleaned up deployment artifacts"
        fi

    - name: Notify success
      if: success()
      run: |
        echo "âœ… Deployment to production completed successfully"
        echo "ğŸŒ Your application should be live at your server"
        echo "ğŸ“Š Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"

    - name: Notify failure
      if: failure()
      run: |
        echo "âŒ Deployment to production failed"
        echo "ğŸ“Š Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ” Check the logs above for details"
